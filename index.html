<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIPP - PP At-Taufiiqiyyah Bustanul Maarif</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary: #0f5132; --accent: #ffc107; --bg: #f4f6f9; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; }
        
        /* Layout */
        .sidebar { width: 260px; background: var(--primary); color: white; min-height: 100vh; position: fixed; z-index: 1000; transition: 0.3s; }
        .main-content { margin-left: 260px; padding: 20px; transition: 0.3s; }
        
        /* Nav */
        .nav-link { color: rgba(255,255,255,0.8) !important; padding: 10px 20px; border-radius: 0 25px 25px 0; margin-bottom: 2px; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background: var(--accent); color: #000 !important; font-weight: bold; }
        .nav-link i { width: 25px; text-align: center; margin-right: 10px; }
        
        /* Components */
        .card-stat { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .pass-wrapper { position: relative; }
        .pass-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #666; }
        
        /* Badges */
        .badge-hutang { background: #dc3545; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Grid Laporan */
        .grid-cell { width: 25px; height: 25px; display: inline-block; text-align: center; line-height: 25px; font-size: 10px; color: white; margin: 1px; border-radius: 3px; }
        .bg-ok { background: #198754; } .bg-no { background: #dc3545; } .bg-free { background: purple; }

        @media (max-width: 768px) { .sidebar { margin-left: -260px; } .sidebar.active { margin-left: 0; } .main-content { margin-left: 0; } }
    </style>
</head>
<body>

    <div id="page-login" style="position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, #0f5132, #000); z-index:9999; display:flex; align-items:center; justify-content:center;">
        <div class="card p-4 text-center shadow-lg" style="width:100%; max-width:380px; border-radius:15px;">
            <img src="logo.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2000/2000762.png'" width="80" class="mx-auto d-block mb-2">
            <h5 class="fw-bold text-success">PP AT-TAUFIIQIYYAH</h5>
            <small class="text-muted d-block mb-4">BUSTANUL MAARIF</small>
            <form id="formLogin">
                <div class="form-floating mb-3 text-start">
                    <input type="text" class="form-control" id="uName" placeholder="User" required>
                    <label>Username</label>
                </div>
                <div class="form-floating mb-3 text-start pass-wrapper">
                    <input type="password" class="form-control" id="uPass" placeholder="Pass" required>
                    <label>Password</label>
                    <i class="fas fa-eye pass-toggle" onclick="togglePass()"></i>
                </div>
                <button type="submit" class="btn btn-success w-100 fw-bold py-2">MASUK APLIKASI</button>
            </form>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <div class="sidebar" id="sidebar">
            <div class="p-4 text-center border-bottom border-white-50">
                <img src="logo.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2000/2000762.png'" width="60" class="bg-white rounded-circle p-1 mb-2">
                <div class="fw-bold small">PP AT-TAUFIIQIYYAH<br>BUSTANUL MAARIF</div>
            </div>
            <nav class="nav flex-column mt-3">
                <a class="nav-link active" onclick="nav('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a class="nav-link" onclick="nav('santri')"><i class="fas fa-user-graduate"></i> Data Santri</a>
                <a class="nav-link" onclick="nav('pembayaran')"><i class="fas fa-cash-register"></i> Pembayaran</a>
                <a class="nav-link" onclick="nav('arsip')"><i class="fas fa-box-archive"></i> Arsip / Alumni</a>
                <a class="nav-link" onclick="nav('laporan')"><i class="fas fa-print"></i> Laporan</a>
                <a class="nav-link" onclick="nav('pengaturan')"><i class="fas fa-cogs"></i> Pengaturan</a>
                <a class="nav-link text-warning mt-4" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Keluar</a>
            </nav>
        </div>

        <div class="main-content">
            <button class="btn btn-success d-md-none mb-3" onclick="document.getElementById('sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>

            <div id="view-dashboard" class="view-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="fw-bold mb-0">Dashboard Keuangan</h4>
                        <span class="badge bg-success fs-6 mt-1" id="dashPeriode">...</span>
                    </div>
                    <div class="text-end d-none d-md-block">
                        <h4 id="jam" class="fw-bold text-primary mb-0">00:00</h4>
                        <small id="tanggal">-</small>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card card-stat p-3 h-100 border-start border-5 border-primary">
                            <small class="text-muted fw-bold">SANTRI WAJIB BAYAR</small>
                            <h3 class="mt-2" id="dashJml">0</h3>
                            <small class="text-muted" id="dashInfoBebas" style="font-size:11px">0 Bebas Syahriah</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-stat p-3 h-100 border-start border-5 border-info">
                            <small class="text-muted fw-bold">TARGET BULAN INI</small>
                            <h4 class="mt-2 text-primary" id="dashTarget">Rp 0</h4>
                            <small class="text-muted" style="font-size:10px">(Santri Aktif x Nominal)</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-stat p-3 h-100 border-start border-5 border-success">
                            <small class="text-muted fw-bold">TOTAL UANG MASUK</small>
                            <h4 class="mt-2 text-success" id="dashMasuk">Rp 0</h4>
                            <div style="font-size:10px; line-height:1.2">
                                Syahriah Bln Ini: <b id="splitSyahriah">0</b><br>
                                Pelunasan Tunggakan: <b id="splitTunggakan">0</b>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-stat p-3 h-100 border-start border-5 border-danger">
                            <small class="text-muted fw-bold">BELUM MASUK (CURRENT)</small>
                            <h4 class="mt-2 text-danger" id="dashKurang">Rp 0</h4>
                            <small class="text-muted" style="font-size:10px">Target - Syahriah Masuk</small>
                        </div>
                    </div>
                </div>

                <div class="card card-stat p-3">
                    <h6 class="fw-bold">Grafik Pemasukan Tahun Ini</h6>
                    <div style="height: 300px;"><canvas id="chartRevenue"></canvas></div>
                </div>
            </div>

            <div id="view-santri" class="view-section" style="display:none;">
                <h4 class="fw-bold mb-3">Data Santri</h4>
                <div class="row g-2 mb-3">
                    <div class="col-md-3"><div class="card p-2 text-center bg-primary text-white small"><span class="fw-bold">Total Santri</span><h5 id="cntAll" class="m-0">0</h5></div></div>
                    <div class="col-md-3"><div class="card p-2 text-center bg-info text-white small"><span class="fw-bold">Putra (L)</span><h5 id="cntL" class="m-0">0</h5></div></div>
                    <div class="col-md-3"><div class="card p-2 text-center bg-warning text-dark small"><span class="fw-bold">Putri (P)</span><h5 id="cntP" class="m-0">0</h5></div></div>
                    <div class="col-md-3"><div class="card p-2 text-center bg-secondary text-white small"><span class="fw-bold">Bebas Syahriah</span><h5 id="cntFree" class="m-0">0</h5></div></div>
                </div>

                <div class="card card-stat p-3 mb-3">
                    <div class="row g-2">
                        <div class="col-md-4"><input type="file" id="fileExcel" class="form-control form-control-sm" accept=".xlsx"></div>
                        <div class="col-md-2"><button onclick="importExcel()" class="btn btn-success btn-sm w-100"><i class="fas fa-file-excel"></i> Import</button></div>
                        <div class="col-md-3"><button onclick="modalSantri()" class="btn btn-primary btn-sm w-100"><i class="fas fa-plus"></i> Tambah Baru</button></div>
                        <div class="col-md-3"><input type="text" id="cariSantri" class="form-control form-control-sm" placeholder="Cari nama..." onkeyup="renderSantri()"></div>
                    </div>
                </div>
                <div class="table-responsive bg-white rounded p-2 shadow-sm">
                    <table class="table table-hover table-sm align-middle">
                        <thead class="table-light"><tr><th>No</th><th>Nama</th><th>L/P</th><th>Kelas</th><th>Status Bayar</th><th class="text-end">Aksi</th></tr></thead>
                        <tbody id="tblSantri"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-pembayaran" class="view-section" style="display:none;">
                <h4 class="fw-bold mb-3">Kasir Pembayaran</h4>
                <div class="card card-stat p-3 mb-3 bg-light">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-2 fw-bold">Pilih Bulan:</div>
                        <div class="col-md-3">
                            <select id="payBulan" class="form-select form-select-sm" onchange="renderBayar()">
                                <option value="0">Januari</option><option value="1">Februari</option><option value="2">Maret</option>
                                <option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option>
                                <option value="6">Juli</option><option value="7">Agustus</option><option value="8">September</option>
                                <option value="9">Oktober</option><option value="10">November</option><option value="11">Desember</option>
                            </select>
                        </div>
                        <div class="col-md-2"><select id="payTahun" class="form-select form-select-sm" onchange="renderBayar()"></select></div>
                        <div class="col-md-5"><input type="text" id="cariBayar" class="form-control form-control-sm" placeholder="Cari santri..." onkeyup="renderBayar()"></div>
                    </div>
                </div>
                <div class="table-responsive bg-white rounded p-2 shadow-sm">
                    <table class="table table-hover table-sm align-middle">
                        <thead class="table-light"><tr><th>Nama</th><th>Kelas</th><th>Info Tunggakan</th><th>Status Bulan Ini</th><th class="text-end">Aksi</th></tr></thead>
                        <tbody id="tblBayar"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-arsip" class="view-section" style="display:none;">
                <h4 class="fw-bold mb-3">Arsip Alumni / Non-Aktif</h4>
                <div class="alert alert-info py-2 small"><i class="fas fa-info-circle"></i> Santri di sini tidak masuk tagihan bulan baru, tapi hutang lama tetap tercatat dan bisa dicicil.</div>
                <div class="table-responsive bg-white rounded p-2 shadow-sm">
                    <table class="table table-hover table-sm align-middle">
                        <thead class="table-light"><tr><th>Nama</th><th>Ket. Keluar</th><th>Sisa Hutang</th><th class="text-end">Aksi</th></tr></thead>
                        <tbody id="tblArsip"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-laporan" class="view-section" style="display:none;">
                <h4 class="fw-bold mb-3">Laporan Keuangan</h4>
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item"><a class="nav-link active text-dark" data-bs-toggle="tab" href="#tabBulanan">Rekap Bulanan</a></li>
                    <li class="nav-item"><a class="nav-link text-dark" data-bs-toggle="tab" href="#tabTahunan">Matriks Tahunan</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tabBulanan">
                        <div class="card card-stat p-3">
                            <div class="row g-2">
                                <div class="col-md-4"><label>Bulan</label><select id="lapBulan" class="form-select"></select></div>
                                <div class="col-md-4"><label>Tahun</label><select id="lapTahun" class="form-select"></select></div>
                                <div class="col-md-4 d-flex align-items-end"><button onclick="cetakBulanan()" class="btn btn-primary w-100"><i class="fas fa-file-pdf"></i> Download PDF</button></div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tabTahunan">
                        <div class="card card-stat p-3">
                            <div class="d-flex justify-content-between mb-2">
                                <select id="gridTahun" class="form-select w-auto" onchange="renderGrid()"></select>
                                <div>
                                    <span class="badge bg-ok me-1">Lunas</span><span class="badge bg-no me-1">Belum</span><span class="badge bg-free">Bebas</span>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm text-center" style="font-size:0.8rem">
                                    <thead class="table-dark">
                                        <tr><th rowspan="2" class="align-middle">Nama</th><th colspan="12">Bulan</th></tr>
                                        <tr><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th></tr>
                                    </thead>
                                    <tbody id="tblGrid"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-pengaturan" class="view-section" style="display:none;">
                <h4 class="fw-bold mb-3">Pengaturan</h4>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card card-stat p-3 h-100">
                            <h6 class="fw-bold border-bottom pb-2">Data Pondok & Petugas</h6>
                            <div class="mb-2"><label class="small">Nominal Syahriah (Rp)</label><input type="number" id="confNominal" class="form-control form-control-sm"></div>
                            <div class="mb-2"><label class="small">Daftar Petugas (Pisah dengan koma)</label><textarea id="confPetugas" class="form-control form-control-sm" rows="3"></textarea></div>
                            <button onclick="saveConf('finance')" class="btn btn-primary btn-sm mt-2">Simpan Data</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card card-stat p-3 h-100">
                            <h6 class="fw-bold border-bottom pb-2">Akun & Backup</h6>
                            <div class="input-group input-group-sm mb-2"><span class="input-group-text">User</span><input type="text" id="confUser" class="form-control"></div>
                            <div class="input-group input-group-sm mb-2"><span class="input-group-text">Pass</span><input type="text" id="confPass" class="form-control"></div>
                            <button onclick="saveConf('account')" class="btn btn-warning btn-sm mb-3">Update Akun</button>
                            <hr>
                            <button onclick="downloadBackup()" class="btn btn-outline-dark btn-sm w-100 mb-2"><i class="fas fa-download"></i> Backup Data</button>
                            <button onclick="document.getElementById('fileRestore').click()" class="btn btn-outline-danger btn-sm w-100"><i class="fas fa-upload"></i> Restore Data</button>
                            <input type="file" id="fileRestore" hidden accept=".json" onchange="restoreBackup(this)">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const DB_KEY = 'SIPP_FINAL_V3';
        const defaultDB = {
            config: { nominal: 100000, user: 'admin', pass: '123', petugas: ['Admin','Bendahara'] },
            santri: [],     // {id, nama, gender, kelas, isFree, status, debt, notes}
            transaksi: []   // {id, idSantri, month, year, nominal, date, type, petugas}
        };
        let myChart = null;
        let petugasList = [];

        // --- CORE ---
        function getDB() { return JSON.parse(localStorage.getItem(DB_KEY) || JSON.stringify(defaultDB)); }
        function saveDB(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }
        function formatRp(n) { return new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}).format(n); }
        
        // --- AUTH ---
        if(sessionStorage.getItem('login')) showApp();
        document.getElementById('formLogin').addEventListener('submit', e => {
            e.preventDefault();
            const db = getDB();
            if(document.getElementById('uName').value === db.config.user && document.getElementById('uPass').value === db.config.pass) {
                sessionStorage.setItem('login', true);
                showApp();
            } else Swal.fire('Error','Username/Password Salah','error');
        });
        function togglePass() {
            const el = document.getElementById('uPass');
            el.type = el.type === 'password' ? 'text' : 'password';
        }
        function logout() { sessionStorage.removeItem('login'); location.reload(); }

        // --- NAV & INIT ---
        function showApp() {
            document.getElementById('page-login').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            // Init Dropdowns
            const curY = new Date().getFullYear();
            ['payTahun','lapTahun','gridTahun'].forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.innerHTML = '';
                    for(let y=curY-2; y<=curY+2; y++) el.innerHTML += `<option value="${y}" ${y===curY?'selected':''}>${y}</option>`;
                }
            });
            const blnNames = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agt','Sep','Okt','Nov','Des'];
            blnNames.forEach((b,i) => document.getElementById('lapBulan').innerHTML += `<option value="${i}" ${i===new Date().getMonth()?'selected':''}>${b}</option>`);

            setInterval(() => {
                document.getElementById('jam').innerText = new Date().toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
                document.getElementById('tanggal').innerText = new Date().toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'short'});
            }, 1000);
            nav('dashboard');
        }

        function nav(page) {
            document.querySelectorAll('.view-section').forEach(e => e.style.display = 'none');
            document.getElementById('view-'+page).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
            event.target.closest('.nav-link').classList.add('active');
            
            if(page==='dashboard') loadDash();
            if(page==='santri') renderSantri();
            if(page==='pembayaran') renderBayar();
            if(page==='arsip') renderArsip();
            if(page==='laporan') renderGrid();
            if(page==='pengaturan') loadConf();
        }

        // --- DASHBOARD ---
        function loadDash() {
            const db = getDB();
            const now = new Date();
            const bln = now.getMonth();
            const thn = now.getFullYear();
            const blnNama = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
            
            document.getElementById('dashPeriode').innerText = `${blnNama[bln]} ${thn}`;
            
            const aktif = db.santri.filter(s => s.status === 'aktif');
            const bebas = aktif.filter(s => s.isFree);
            const wajib = aktif.filter(s => !s.isFree);
            
            document.getElementById('dashJml').innerText = wajib.length;
            document.getElementById('dashInfoBebas').innerText = `${bebas.length} Bebas Syahriah`;
            
            const target = wajib.length * db.config.nominal;
            document.getElementById('dashTarget').innerText = formatRp(target);
            
            // Hitung Uang Masuk (Split Syahriah Bulan Ini vs Tunggakan)
            let syahriahNow = 0;
            let tunggakanMasuk = 0;
            
            db.transaksi.forEach(t => {
                // Hanya hitung transaksi yang dilakukan di bulan ini (tanggal bayar bulan ini)
                // Asumsi: kita hitung CASHFLOW bulan ini, bukan alokasi bulan ini.
                const tDate = new Date(t.date);
                if(tDate.getMonth() === bln && tDate.getFullYear() === thn) {
                    if(t.type === 'syahriah' && parseInt(t.month) === bln && parseInt(t.year) === thn) {
                        syahriahNow += parseInt(t.nominal);
                    } else {
                        tunggakanMasuk += parseInt(t.nominal);
                    }
                }
            });
            
            document.getElementById('dashMasuk').innerText = formatRp(syahriahNow + tunggakanMasuk);
            document.getElementById('splitSyahriah').innerText = formatRp(syahriahNow);
            document.getElementById('splitTunggakan').innerText = formatRp(tunggakanMasuk);
            
            // Belum Masuk = Target - Yang sudah bayar syahriah bulan ini
            const kurang = target - syahriahNow;
            document.getElementById('dashKurang').innerText = formatRp(kurang > 0 ? kurang : 0);

            // Chart Tahunan
            const ctx = document.getElementById('chartRevenue').getContext('2d');
            const dataChart = new Array(12).fill(0);
            db.transaksi.forEach(t => {
                const tDate = new Date(t.date);
                if(tDate.getFullYear() === thn) {
                    dataChart[tDate.getMonth()] += parseInt(t.nominal);
                }
            });

            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: blnNama,
                    datasets: [{ label: 'Pemasukan (Rp)', data: dataChart, backgroundColor: '#0f5132' }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- SANTRI ---
        function renderSantri() {
            const db = getDB();
            const key = document.getElementById('cariSantri').value.toLowerCase();
            const tbody = document.getElementById('tblSantri');
            tbody.innerHTML = '';
            
            const list = db.santri.filter(s => s.status === 'aktif' && s.nama.toLowerCase().includes(key));
            
            // Stats
            document.getElementById('cntAll').innerText = list.length;
            document.getElementById('cntL').innerText = list.filter(s=>s.gender==='L').length;
            document.getElementById('cntP').innerText = list.filter(s=>s.gender==='P').length;
            document.getElementById('cntFree').innerText = list.filter(s=>s.isFree).length;

            list.forEach((s, i) => {
                const badgeStatus = s.isFree ? '<span class="badge bg-secondary">Bebas Syahriah</span>' : '<span class="badge bg-success">Wajib Bayar</span>';
                tbody.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td class="fw-bold">${s.nama}</td>
                        <td>${s.gender}</td>
                        <td>${s.kelas}</td>
                        <td>${badgeStatus}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-warning" onclick="editSantri(${s.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="archSantri(${s.id})"><i class="fas fa-user-times"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function modalSantri(id=null) {
            const db = getDB();
            let s = {nama:'', gender:'L', kelas:'', isFree:false};
            if(id) s = db.santri.find(x => x.id === id);

            Swal.fire({
                title: id ? 'Edit Santri' : 'Tambah Santri',
                html: `
                    <input id="swal-nama" class="swal2-input" placeholder="Nama Lengkap" value="${s.nama}">
                    <select id="swal-gen" class="swal2-input"><option value="L" ${s.gender=='L'?'selected':''}>Laki-laki</option><option value="P" ${s.gender=='P'?'selected':''}>Perempuan</option></select>
                    <input id="swal-cls" class="swal2-input" placeholder="Kelas" value="${s.kelas}">
                    <div class="mt-3 text-start px-5">
                        <input type="checkbox" id="swal-free" ${s.isFree?'checked':''}> <label for="swal-free">Bebas Syahriah (Gratis)</label>
                    </div>
                `,
                showCancelButton: true,
                preConfirm: () => {
                    return {
                        nama: document.getElementById('swal-nama').value,
                        gender: document.getElementById('swal-gen').value,
                        kelas: document.getElementById('swal-cls').value,
                        isFree: document.getElementById('swal-free').checked
                    }
                }
            }).then(r => {
                if(r.isConfirmed && r.value.nama) {
                    const db = getDB();
                    if(id) {
                        const idx = db.santri.findIndex(x=>x.id===id);
                        db.santri[idx] = {...db.santri[idx], ...r.value};
                    } else {
                        db.santri.push({id: Date.now(), ...r.value, status:'aktif'});
                    }
                    saveDB(db);
                    renderSantri();
                    Swal.fire('Sukses','Data tersimpan','success');
                }
            });
        }
        window.editSantri = modalSantri;

        function archSantri(id) {
            const db = getDB();
            const s = db.santri.find(x => x.id === id);
            
            // HITUNG HUTANG TAHUN BERJALAN (Otomatis)
            const curMonth = new Date().getMonth(); 
            const curYear = new Date().getFullYear();
            let hutangTahunIni = 0;

            if(!s.isFree) {
                for(let m=0; m <= curMonth; m++) {
                    const lunas = db.transaksi.some(t => t.idSantri === id && parseInt(t.month) === m && parseInt(t.year) === curYear && t.type === 'syahriah');
                    if(!lunas) hutangTahunIni += db.config.nominal;
                }
            }

            Swal.fire({
                title: 'Non-Aktifkan Santri',
                html: `
                    <p class="small text-muted mb-2">Sistem menghitung hutang berjalan otomatis. Silakan tambah hutang masa lalu jika ada.</p>
                    <label class="small fw-bold">Alasan Keluar</label>
                    <input id="arc-note" class="form-control mb-2" placeholder="Contoh: Boyong / Lulus">
                    
                    <label class="small fw-bold">Tunggakan Tahun Ini (Hitungan Sistem)</label>
                    <input id="arc-sys" class="form-control mb-2 bg-light" value="${hutangTahunIni}" readonly>
                    
                    <label class="small fw-bold text-danger">Tunggakan Tahun Lalu / Warisan (Input Manual)</label>
                    <input type="number" id="arc-man" class="form-control mb-3" value="0">
                `,
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Non-Aktifkan',
                preConfirm: () => {
                    return {
                        note: document.getElementById('arc-note').value,
                        total: parseInt(document.getElementById('arc-sys').value) + parseInt(document.getElementById('arc-man').value)
                    }
                }
            }).then(r => {
                if(r.isConfirmed) {
                    const db = getDB();
                    const idx = db.santri.findIndex(x=>x.id===id);
                    db.santri[idx].status = 'arsip';
                    db.santri[idx].notes = r.value.note;
                    db.santri[idx].debt = r.value.total;
                    saveDB(db);
                    renderSantri();
                    Swal.fire('Berhasil', `Santri dipindahkan ke Arsip dengan Hutang Rp ${formatRp(r.value.total)}`, 'success');
                }
            });
        }
        
        function importExcel() {
            const f = document.getElementById('fileExcel').files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                const wb = XLSX.read(e.target.result, {type:'binary'});
                const js = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                const db = getDB();
                let c = 0;
                for(let i=1; i<js.length; i++) {
                    if(js[i][0]) {
                        db.santri.push({id: Date.now()+i, nama: js[i][0], kelas: js[i][1]||'-', gender:'L', isFree:false, status:'aktif'});
                        c++;
                    }
                }
                saveDB(db);
                renderSantri();
                Swal.fire('Sukses', c+' Data diimpor', 'success');
            };
            r.readAsBinaryString(f);
        }

        // --- PEMBAYARAN ---
        function renderBayar() {
            const db = getDB();
            const bln = parseInt(document.getElementById('payBulan').value);
            const thn = parseInt(document.getElementById('payTahun').value);
            const key = document.getElementById('cariBayar').value.toLowerCase();
            const tbody = document.getElementById('tblBayar');
            tbody.innerHTML = '';
            
            const list = db.santri.filter(s => s.status === 'aktif' && s.nama.toLowerCase().includes(key));
            
            // Logic Cek Tunggakan (Mundur 1 bulan ke belakang)
            const prevDate = new Date(); prevDate.setMonth(prevDate.getMonth()-1);
            const prevM = prevDate.getMonth(); const prevY = prevDate.getFullYear();

            list.forEach(s => {
                const isPaid = db.transaksi.some(t => t.idSantri === s.id && parseInt(t.month) === bln && parseInt(t.year) === thn && t.type === 'syahriah');
                
                // Cek hutang bulan lalu
                let badgeHutang = '<span class="badge bg-light text-dark">Aman</span>';
                if(!s.isFree) {
                     const lunasLalu = db.transaksi.some(t => t.idSantri === s.id && parseInt(t.month) === prevM && parseInt(t.year) === prevY && t.type === 'syahriah');
                     if(!lunasLalu) badgeHutang = '<span class="badge badge-hutang">Ada Tunggakan</span>';
                }

                let statusBtn = '';
                if(s.isFree) statusBtn = '<span class="badge bg-secondary">Gratis</span>';
                else if(isPaid) statusBtn = '<span class="badge bg-success">LUNAS</span>';
                else statusBtn = `<button class="btn btn-sm btn-primary" onclick="bayar(${s.id})">Bayar</button>`;

                tbody.innerHTML += `<tr><td>${s.nama}</td><td>${s.kelas}</td><td>${badgeHutang}</td><td>${statusBtn}</td><td class="text-end"><button class="btn btn-sm btn-info" onclick="historySantri(${s.id})"><i class="fas fa-history"></i></button></td></tr>`;
            });
        }

        function bayar(id) {
            const db = getDB();
            const s = db.santri.find(x => x.id === id);
            const petugasOpts = db.config.petugas.map(p => `<option value="${p}">${p}</option>`).join('');
            
            Swal.fire({
                title: 'Input Pembayaran',
                html: `
                    <p class="fw-bold mb-0">${s.nama}</p>
                    <small class="text-muted mb-3 d-block">Pembayaran Syahriah</small>
                    <label class="small text-start w-100">Tanggal Bayar</label>
                    <input type="date" id="byr-tgl" class="form-control mb-2" value="${new Date().toISOString().slice(0,10)}">
                    <label class="small text-start w-100">Petugas Penerima</label>
                    <select id="byr-ptg" class="form-select mb-2">${petugasOpts}</select>
                `,
                showCancelButton: true,
                confirmButtonText: 'Simpan Bayar'
            }).then(r => {
                if(r.isConfirmed) {
                    const bln = document.getElementById('payBulan').value;
                    const thn = document.getElementById('payTahun').value;
                    db.transaksi.push({
                        id: Date.now(), idSantri: id, month: bln, year: thn, 
                        nominal: db.config.nominal, date: document.getElementById('byr-tgl').value,
                        petugas: document.getElementById('byr-ptg').value, type: 'syahriah'
                    });
                    saveDB(db);
                    renderBayar();
                    Swal.fire('Sukses','Pembayaran diterima','success');
                }
            });
        }

        function historySantri(id) {
            const db = getDB();
            const s = db.santri.find(x=>x.id===id);
            const trxs = db.transaksi.filter(t=>t.idSantri===id).sort((a,b)=> new Date(b.date) - new Date(a.date));
            
            let html = `<table class="table table-sm text-start" style="font-size:0.8rem"><thead><tr><th>Tgl</th><th>Ket</th><th>Nominal</th></tr></thead><tbody>`;
            trxs.forEach(t => {
                const ket = t.type==='syahriah' ? `Syahriah ${parseInt(t.month)+1}/${t.year}` : 'Cicilan Hutang';
                html += `<tr><td>${t.date}</td><td>${ket}</td><td>${formatRp(t.nominal)}</td></tr>`;
            });
            html += `</tbody></table>`;
            
            Swal.fire({ title: `Riwayat: ${s.nama}`, html: html, width: '600px', showCloseButton: true });
        }

        // --- ARSIP ---
        function renderArsip() {
            const db = getDB();
            const tbody = document.getElementById('tblArsip');
            tbody.innerHTML = '';
            
            db.santri.filter(s => s.status === 'arsip').forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${s.nama}</td>
                        <td>${s.notes}</td>
                        <td class="text-danger fw-bold">${formatRp(s.debt)}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-success" onclick="cicilHutang(${s.id})">Bayar/Cicil</button>
                        </td>
                    </tr>`;
            });
        }

        function cicilHutang(id) {
            const db = getDB();
            const s = db.santri.find(x => x.id === id);
            const petugasOpts = db.config.petugas.map(p => `<option value="${p}">${p}</option>`).join('');

            Swal.fire({
                title: 'Bayar Hutang Alumni',
                html: `
                    <p>Sisa Hutang: <b>${formatRp(s.debt)}</b></p>
                    <input type="number" id="cicil-nom" class="form-control mb-2" placeholder="Nominal Bayar">
                    <select id="cicil-ptg" class="form-select">${petugasOpts}</select>
                `,
                showCancelButton: true,
                confirmButtonText: 'Bayar'
            }).then(r => {
                if(r.isConfirmed) {
                    const nom = parseInt(document.getElementById('cicil-nom').value);
                    if(nom > 0) {
                        s.debt -= nom; // Kurangi hutang
                        db.transaksi.push({
                            id: Date.now(), idSantri: id, month: new Date().getMonth(), year: new Date().getFullYear(),
                            nominal: nom, date: new Date().toISOString().slice(0,10), 
                            petugas: document.getElementById('cicil-ptg').value, type: 'cicilan'
                        });
                        saveDB(db);
                        renderArsip();
                        Swal.fire('Sukses', `Sisa hutang kini: ${formatRp(s.debt)}`, 'success');
                    }
                }
            });
        }

        // --- LAPORAN ---
        function renderGrid() {
            const db = getDB();
            const thn = document.getElementById('gridTahun').value;
            const tbody = document.getElementById('tblGrid');
            tbody.innerHTML = '';

            const list = db.santri.filter(s => s.status === 'aktif');
            list.forEach(s => {
                let cells = '';
                for(let m=0; m<12; m++) {
                    if(s.isFree) {
                        cells += `<td><div class="grid-cell bg-free">OK</div></td>`;
                    } else {
                        const paid = db.transaksi.some(t => t.idSantri === s.id && parseInt(t.month) === m && parseInt(t.year) == thn && t.type === 'syahriah');
                        const cls = paid ? 'bg-ok' : 'bg-no';
                        const txt = paid ? 'OK' : 'X';
                        cells += `<td><div class="grid-cell ${cls}">${txt}</div></td>`;
                    }
                }
                tbody.innerHTML += `<tr><td class="text-start ps-2 fw-bold" style="white-space:nowrap">${s.nama}</td>${cells}</tr>`;
            });
        }
        
        function cetakBulanan() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const db = getDB();
            
            const blnIdx = parseInt(document.getElementById('lapBulan').value);
            const thn = parseInt(document.getElementById('lapTahun').value);
            const namaBulan = document.getElementById('lapBulan').options[blnIdx].text;

            doc.setFontSize(14); doc.text("LAPORAN KEUANGAN BULANAN", 14, 15);
            doc.setFontSize(10); doc.text(`Periode: ${namaBulan} ${thn}`, 14, 22);

            let totalSyahriah = 0;
            let totalTunggakan = 0;

            const rows = db.transaksi
                .filter(t => {
                    const d = new Date(t.date);
                    return d.getMonth() === blnIdx && d.getFullYear() === thn;
                })
                .map((t, i) => {
                    const s = db.santri.find(x => x.id === t.idSantri); // Cari nama santri (bisa jadi alumni)
                    const nama = s ? s.nama : "Hapus/Unknown";
                    
                    if(t.type === 'syahriah') totalSyahriah += parseInt(t.nominal);
                    else totalTunggakan += parseInt(t.nominal);

                    return [i+1, t.date, nama, t.type.toUpperCase(), formatRp(t.nominal), t.petugas];
                });

            doc.autoTable({
                startY: 30,
                head: [['No', 'Tanggal', 'Nama', 'Tipe', 'Nominal', 'Petugas']],
                body: rows,
            });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total Syahriah: ${formatRp(totalSyahriah)}`, 14, finalY);
            doc.text(`Total Cicilan Tunggakan: ${formatRp(totalTunggakan)}`, 14, finalY + 6);
            doc.text(`GRAND TOTAL: ${formatRp(totalSyahriah + totalTunggakan)}`, 14, finalY + 14);

            doc.save(`Laporan_${namaBulan}_${thn}.pdf`);
        }

        // --- CONFIG ---
        function loadConf() {
            const db = getDB();
            document.getElementById('confNominal').value = db.config.nominal;
            document.getElementById('confPetugas').value = db.config.petugas.join(', ');
            document.getElementById('confUser').value = db.config.user;
            document.getElementById('confPass').value = db.config.pass;
        }
        function saveConf(type) {
            const db = getDB();
            if(type === 'finance') {
                db.config.nominal = parseInt(document.getElementById('confNominal').value);
                db.config.petugas = document.getElementById('confPetugas').value.split(',').map(s=>s.trim());
            } else {
                db.config.user = document.getElementById('confUser').value;
                db.config.pass = document.getElementById('confPass').value;
            }
            saveDB(db);
            Swal.fire('Saved', 'Pengaturan disimpan', 'success');
        }
        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(localStorage.getItem(DB_KEY));
            const el = document.createElement('a');
            el.setAttribute("href", dataStr);
            el.setAttribute("download", `BACKUP_PONDOK_${new Date().toISOString().slice(0,10)}.json`);
            el.click();
        }
        function restoreBackup(input) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.santri && json.config) {
                        localStorage.setItem(DB_KEY, JSON.stringify(json));
                        Swal.fire('Sukses','Data dipulihkan','success').then(()=>location.reload());
                    } else throw new Error();
                } catch(err) { Swal.fire('Error','File backup tidak valid','error'); }
            };
            reader.readAsText(input.files[0]);
        }
    </script>
</body>
</html>
